<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmegaMesh - 8 User Video Grid</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            --bg-dark: #09090b;       /* Deep Black/Grey */
            --bg-card: #18181b;       /* Card BG */
            --primary: #6366f1;       /* Indigo */
            --primary-hover: #4f46e5;
            --danger: #ef4444;        /* Red */
            --success: #22c55e;       /* Green */
            --text-main: #fafafa;
            --text-muted: #a1a1aa;
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.6);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- 2. START SCREEN (SELECTION) --- */
        #setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at top, #1e1b4b 0%, #09090b 100%);
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
        }

        .setup-container {
            width: 90%; max-width: 900px;
            background: var(--bg-card);
            border: var(--border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            position: relative;
            overflow: hidden;
        }

        /* Decoration */
        .setup-container::before {
            content: ''; position: absolute; top: -50px; left: -50px;
            width: 150px; height: 150px; background: var(--primary);
            filter: blur(80px); opacity: 0.4; border-radius: 50%;
        }

        .info-side h1 { font-size: 3rem; font-weight: 800; line-height: 1.1; margin-bottom: 15px; }
        .info-side h1 span { color: var(--primary); }
        .info-side p { color: var(--text-muted); font-size: 1.1rem; line-height: 1.6; }
        
        .features-list { margin-top: 30px; display: grid; gap: 15px; }
        .feature { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; }
        .feature i { color: var(--success); font-size: 1.2rem; }

        .action-side { display: flex; flex-direction: column; justify-content: center; gap: 20px; }
        
        /* Tabs */
        .type-selector {
            display: flex; background: #27272a; padding: 5px; border-radius: 12px; margin-bottom: 10px;
        }
        .type-btn {
            flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-muted);
            font-weight: 600; cursor: pointer; border-radius: 8px; transition: 0.3s;
        }
        .type-btn.active { background: var(--bg-card); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        /* Inputs */
        .input-group label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px; }
        .input-box {
            width: 100%; padding: 14px; background: #09090b; border: 1px solid #3f3f46;
            color: white; border-radius: 10px; font-size: 1rem; outline: none; transition: 0.3s;
        }
        .input-box:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }

        /* Public Rooms Grid */
        .public-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; display: none; }
        .public-card {
            background: #27272a; padding: 15px; border-radius: 10px; cursor: pointer; text-align: center;
            border: 1px solid transparent; transition: 0.2s;
        }
        .public-card:hover { border-color: var(--primary); background: #3f3f46; }
        .public-card h3 { font-size: 1rem; margin-bottom: 5px; }
        .public-card span { font-size: 0.8rem; color: var(--success); }

        .btn-launch {
            width: 100%; padding: 16px; background: var(--primary); color: white;
            border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; margin-top: 10px; transition: 0.3s;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-launch:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-launch:disabled { background: #3f3f46; cursor: not-allowed; transform: none; }

        /* --- 3. MAIN APP UI --- */
        #app-screen { display: none; height: 100%; flex-direction: column; }

        /* Top Bar */
        .top-bar {
            height: 70px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; border-bottom: var(--border); background: var(--bg-card);
        }
        .room-badge {
            background: rgba(99, 102, 241, 0.1); color: var(--primary);
            padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        .copy-btn {
            background: transparent; border: 1px solid #3f3f46; color: white;
            padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .copy-btn:hover { background: #27272a; }

        /* Video Grid (THE MAIN PART) */
        .video-container {
            flex: 1; padding: 20px;
            display: grid;
            gap: 15px;
            /* Intelligent Grid Logic for 1 to 8 users */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            grid-auto-rows: 1fr; /* Uniform height */
            justify-content: center; align-content: center;
        }
        
        /* 1.1 Square Dabba Logic */
        .video-box {
            position: relative;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            aspect-ratio: 1 / 1; /* FORCING SQUARE SHAPE */
            width: 100%; height: 100%;
            max-height: 500px; /* Limit height on huge screens */
            margin: auto;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        video { width: 100%; height: 100%; object-fit: cover; }

        .user-label {
            position: absolute; bottom: 15px; left: 15px;
            background: rgba(0,0,0,0.7); color: white;
            padding: 5px 12px; border-radius: 6px; font-size: 0.85rem;
            backdrop-filter: blur(4px); display: flex; align-items: center; gap: 6px;
        }
        .audio-wave { height: 10px; display: flex; gap: 2px; align-items: flex-end; }
        .bar { width: 3px; background: var(--success); animation: wave 1s infinite; }
        @keyframes wave { 0%,100%{height: 3px} 50%{height: 10px} }

        /* Controls Bar */
        .controls-bar {
            height: 90px; background: var(--bg-card); border-top: var(--border);
            display: flex; justify-content: center; align-items: center; gap: 20px;
        }
        .ctrl-btn {
            width: 55px; height: 55px; border-radius: 50%; border: none;
            background: #27272a; color: white; font-size: 1.3rem; cursor: pointer;
            transition: all 0.2s ease; display: flex; justify-content: center; align-items: center;
        }
        .ctrl-btn:hover { background: #3f3f46; transform: translateY(-4px); }
        .ctrl-btn.active { background: var(--primary); box-shadow: 0 0 15px var(--primary); }
        .ctrl-btn.danger { background: var(--danger); }
        .ctrl-btn.off { background: #3f3f46; color: #71717a; position: relative; }
        .ctrl-btn.off::after { content: ''; position: absolute; width: 100%; height: 2px; background: #71717a; transform: rotate(45deg); }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #27272a; border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .status-text { color: var(--primary); font-family: monospace; }

        /* Mobile Responsive */
        @media (max-width: 800px) {
            .setup-container { grid-template-columns: 1fr; padding: 20px; width: 95%; overflow-y: auto; max-height: 90vh; }
            .info-side { display: none; } /* Hide info on mobile to save space */
            .video-container { grid-template-columns: repeat(2, 1fr); padding: 10px; gap: 10px; }
            .video-box { aspect-ratio: 1/1; } /* Keep square */
            .ctrl-btn { width: 45px; height: 45px; font-size: 1.1rem; }
        }
    </style>
</head>
<body>

    <!-- LOADER OVERLAY -->
    <div id="loader">
        <div class="spinner"></div>
        <div class="status-text" id="loading-msg">Connecting to Satellite...</div>
    </div>

    <!-- 1. SETUP SCREEN -->
    <div id="setup-screen">
        <div class="setup-container">
            <!-- Left Info -->
            <div class="info-side">
                <h1>Omega<span>Mesh</span></h1>
                <p>Advanced Peer-to-Peer Grid Conferencing System.</p>
                
                <div class="features-list">
                    <div class="feature"><i class="fas fa-th"></i> <span>Smart 1:1 Video Grid</span></div>
                    <div class="feature"><i class="fas fa-users"></i> <span>Max 8 Users Per Room</span></div>
                    <div class="feature"><i class="fas fa-lock"></i> <span>End-to-End Encryption</span></div>
                    <div class="feature"><i class="fas fa-bolt"></i> <span>Low Latency Mesh</span></div>
                </div>
            </div>

            <!-- Right Actions -->
            <div class="action-side">
                <div class="type-selector">
                    <button class="type-btn active" onclick="setMode('private')" id="btn-private">Private Room</button>
                    <button class="type-btn" onclick="setMode('public')" id="btn-public">Public Lobby</button>
                </div>

                <!-- Private Inputs -->
                <div id="private-controls">
                    <div class="input-group">
                        <label>Your Display Name</label>
                        <input type="text" id="username" class="input-box" placeholder="Ex: Agent 47">
                    </div>
                    <div class="input-group" style="margin-top: 15px;">
                        <label>Room ID (Password)</label>
                        <input type="text" id="room-id" class="input-box" placeholder="Ex: secret_base_01">
                    </div>
                </div>

                <!-- Public Grid -->
                <div id="public-controls" class="public-grid">
                    <div class="public-card" onclick="joinPublic('Global_1')">
                        <h3>üåç Global 1</h3><span>Always Open</span>
                    </div>
                    <div class="public-card" onclick="joinPublic('Global_2')">
                        <h3>ü™ê Global 2</h3><span>Always Open</span>
                    </div>
                    <div class="public-card" onclick="joinPublic('Gaming_Hub')">
                        <h3>üéÆ Gaming</h3><span>Gamers Only</span>
                    </div>
                    <div class="public-card" onclick="joinPublic('Chill_Zone')">
                        <h3>‚òï Chill</h3><span>Talk & Relax</span>
                    </div>
                </div>

                <button class="btn-launch" onclick="initApp()">
                    <i class="fas fa-rocket"></i> JOIN SESSION
                </button>
            </div>
        </div>
    </div>

    <!-- 2. APP SCREEN -->
    <div id="app-screen">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="room-badge" id="display-room-name">...</div>
                <div class="room-badge" style="border-color:var(--success); color:var(--success);" id="user-count">
                    <i class="fas fa-user"></i> 1/8
                </div>
            </div>
            <button class="copy-btn" onclick="copyLink()"><i class="fas fa-link"></i> Copy Link</button>
        </div>

        <!-- THIS IS THE 1:1 SQUARE GRID -->
        <div class="video-container" id="video-grid">
            <!-- Videos inject here -->
        </div>

        <div class="controls-bar">
            <button class="ctrl-btn active" onclick="toggleAudio()" id="btn-mic"><i class="fas fa-microphone"></i></button>
            <button class="ctrl-btn active" onclick="toggleVideo()" id="btn-cam"><i class="fas fa-video"></i></button>
            <button class="ctrl-btn" onclick="shareScreen()" id="btn-screen"><i class="fas fa-desktop"></i></button>
            <button class="ctrl-btn danger" onclick="leaveRoom()"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <!-- PEERJS LIBRARY -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <script>
        /**
         * OMEGA MESH LOGIC (The "Gadbad" Fixer)
         * 1. Uses "Smart Scanning" to find a free seat (1-8).
         * 2. Connects to all existing lower seats.
         * 3. Handles disconnects cleanly.
         */

        const MAX_USERS = 8;
        let myPeer = null;
        let myStream = null;
        let mySeat = null;
        let myName = "";
        let currentRoom = "";
        let peers = {}; // Store active calls
        let isScreenSharing = false;

        // UI Refs
        const setupScreen = document.getElementById('setup-screen');
        const appScreen = document.getElementById('app-screen');
        const loader = document.getElementById('loader');
        const loadMsg = document.getElementById('loading-msg');
        const videoGrid = document.getElementById('video-grid');
        
        // --- 1. SELECTION LOGIC ---
        function setMode(mode) {
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');

            if(mode === 'public') {
                document.getElementById('private-controls').style.display = 'none';
                document.getElementById('public-controls').style.display = 'grid';
                document.querySelector('.btn-launch').style.display = 'none'; // Auto join on click
            } else {
                document.getElementById('private-controls').style.display = 'block';
                document.getElementById('public-controls').style.display = 'none';
                document.querySelector('.btn-launch').style.display = 'flex';
            }
        }

        function joinPublic(roomName) {
            const name = prompt("Enter your Name for Public Room:", "Guest");
            if(!name) return;
            document.getElementById('username').value = name;
            document.getElementById('room-id').value = roomName;
            initApp();
        }

        // --- 2. INITIALIZATION (SCANNER) ---
        async function initApp() {
            const name = document.getElementById('username').value.trim();
            const room = document.getElementById('room-id').value.trim().replace(/\s/g, '_');

            if(!name || !room) { alert("Please enter Name and Room ID!"); return; }

            myName = name;
            currentRoom = room;

            // Show Loader
            loader.style.display = 'flex';
            loadMsg.innerText = "Accessing Camera & Mic...";

            try {
                // Get Media
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                
                // Start Scanning for Seats
                loadMsg.innerText = "Scanning Room for Free Seat...";
                mySeat = await findOpenSeat(room);

                if(mySeat === -1) {
                    alert("Room is Full (8/8)! Try another room.");
                    location.reload();
                    return;
                }

                // Initialize Peer with Calculated ID
                const finalID = `${room}_seat_${mySeat}`;
                console.log("My ID:", finalID);
                
                myPeer = new Peer(finalID);

                myPeer.on('open', id => {
                    // UI Switch
                    loader.style.display = 'none';
                    setupScreen.style.display = 'none';
                    appScreen.style.display = 'flex';
                    
                    document.getElementById('display-room-name').innerText = room;
                    
                    // Add My Video
                    addVideo(myStream, myName + " (You)", myPeer.id, true);
                    
                    // CONNECT TO OTHERS (Mesh Logic)
                    connectToPriorUsers();
                });

                // Handle Incoming
                myPeer.on('call', call => {
                    call.answer(myStream);
                    handleCall(call);
                });

                myPeer.on('error', err => {
                    console.error(err);
                    if(err.type === 'peer-unavailable') { /* Ignore */ }
                    else { alert("Connection Error: " + err.type); }
                });

            } catch(e) {
                console.error(e);
                alert("Camera access denied or Error: " + e.message);
                location.reload();
            }
        }

        // --- 3. THE SMART SCANNER (Recursive) ---
        // Checks IDs: Room_seat_1, Room_seat_2... until one works.
        function findOpenSeat(room) {
            return new Promise(async (resolve) => {
                for (let i = 1; i <= MAX_USERS; i++) {
                    loadMsg.innerText = `Checking Seat ${i}...`;
                    const isTaken = await checkIdExists(`${room}_seat_${i}`);
                    if (!isTaken) {
                        resolve(i); // Found free seat!
                        return;
                    }
                }
                resolve(-1); // Full
            });
             }

        // Helper: Tries to connect temporarily to check if ID exists
        function checkIdExists(id) {
            return new Promise(resolve => {
                const tempPeer = new Peer(); // Disposable peer
                tempPeer.on('open', () => {
                    const conn = tempPeer.connect(id);
                    let timeout = setTimeout(() => {
                        tempPeer.destroy();
                        resolve(false); // Timeout = ID likely free
                    }, 1500);

                    conn.on('open', () => {
                        clearTimeout(timeout);
                        conn.close();
                        tempPeer.destroy();
                        resolve(true); // Connected = ID taken
                    });
                    
                    conn.on('error', () => {
                        clearTimeout(timeout);
                        tempPeer.destroy();
                        resolve(false);
                    });
                });
                tempPeer.on('error', () => { resolve(false); });
            });
        }

        // --- 4. MESH CONNECTION ---
        function connectToPriorUsers() {
            // Logic: Connect to everyone with a seat number LOWER than mine.
            // (Higher seats will connect to me when they join).
            for (let i = 1; i < mySeat; i++) {
                const targetId = `${currentRoom}_seat_${i}`;
                console.log("Calling existing user:", targetId);
                
                const call = myPeer.call(targetId, myStream, { metadata: { name: myName } });
                handleCall(call);
            }
        }

        function handleCall(call) {
            const peerId = call.peer;
            peers[peerId] = call;

            call.on('stream', remoteStream => {
                // Get name from metadata if available, else generic
                let remoteName = "User " + peerId.split('_').pop();
                if(call.metadata && call.metadata.name) remoteName = call.metadata.name;
                
                addVideo(remoteStream, remoteName, peerId, false);
                updateCount();
            });

            call.on('close', () => {
                removeVideo(peerId);
                updateCount();
            });
            
            call.on('error', () => removeVideo(peerId));
        }

        // --- 5. GRID UI MANAGER ---
        function addVideo(stream, name, id, isLocal) {
            if(document.getElementById(`vid-${id}`)) return; // Duplicate check

            const box = document.createElement('div');
            box.className = 'video-box';
            box.id = `vid-${id}`;

            const vid = document.createElement('video');
            vid.srcObject = stream;
            vid.autoplay = true;
            vid.playsInline = true;
            if(isLocal) vid.muted = true;
            if(isLocal) vid.style.transform = "scaleX(-1)"; // Mirror local

            const label = document.createElement('div');
            label.className = 'user-label';
            label.innerHTML = `
                ${isLocal ? '' : '<div class="audio-wave"><div class="bar"></div><div class="bar"></div></div>'}
                <span>${name}</span>
            `;

            box.appendChild(vid);
            box.appendChild(label);
            videoGrid.appendChild(box);
            updateCount();
        }

        function removeVideo(id) {
            const el = document.getElementById(`vid-${id}`);
            if(el) el.remove();
        }

        function updateCount() {
            const count = videoGrid.children.length;
            document.getElementById('user-count').innerHTML = `<i class="fas fa-user"></i> ${count}/8`;
        }

        // --- 6. CONTROLS ---
        function toggleAudio() {
            const track = myStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            const btn = document.getElementById('btn-mic');
            btn.classList.toggle('off');
            btn.classList.toggle('active');
            btn.innerHTML = track.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
        }

        function toggleVideo() {
            const track = myStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            const btn = document.getElementById('btn-cam');
            btn.classList.toggle('off');
            btn.classList.toggle('active');
            btn.innerHTML = track.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
        }

        async function shareScreen() {
            if(!isScreenSharing) {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];

                    // Replace track in all connections
                    for(let id in peers) {
                        const sender = peers[id].peerConnection.getSenders().find(s => s.track.kind === 'video');
                        if(sender) sender.replaceTrack(screenTrack);
                    }
                    
                    // Update Local
                    const localVid = document.querySelector(`#vid-${myPeer.id} video`);
                    localVid.srcObject = screenStream;
                    localVid.style.transform = "none"; // Un-mirror

                    screenTrack.onended = stopSharing;
                    isScreenSharing = true;
                    document.getElementById('btn-screen').classList.add('active');

                } catch(e) { console.error("Screen share error", e); }
            } else {
                stopSharing();
            }
        }

        function stopSharing() {
            const camTrack = myStream.getVideoTracks()[0];
            for(let id in peers) {
                const sender = peers[id].peerConnection.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(camTrack);
            }
            const localVid = document.querySelector(`#vid-${myPeer.id} video`);
            localVid.srcObject = myStream;
            localVid.style.transform = "scaleX(-1)";
            
            isScreenSharing = false;
            document.getElementById('btn-screen').classList.remove('active');
        }

        function leaveRoom() {
            if(confirm("Leave Meeting?")) {
                myPeer.destroy();
                location.reload();
            }
        }

        function copyLink() {
            // Since we don't have routing, we just copy the Room Name
            navigator.clipboard.writeText("Join Room: " + currentRoom);
            alert("Room Name Copied: " + currentRoom + "\nShare this name with friends!");
        }

    </script>
</body>
</html>
